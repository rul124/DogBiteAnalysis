--- 
title: Dog Bite Accident Analysis
author: Xiaorui Qin, Ziyu Fang, Ruoxi Liu
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction


<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources


<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

```{r setup, include=FALSE}
# this prevents package loading message from appearing in the rendered version of your problem set
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

### Read the data

We analyze the missing values of our data "Dog Bite Data" from https://data.cityofnewyork.us/Health/DOHMH-Dog-Bite-Data/rsgh-akpg, which contains 10280 rows and 9 columns. We read the data and show the names of the 9 columns for analysis.

```{r}
library(ggplot2)
library(dplyr)
DogBite <- read.csv("DOHMH_Dog_Bite_Data.csv", header = TRUE, na.strings = c(""))
colnames(DogBite)
```

### Missing values by column

```{r}
colSums(is.na(DogBite)) %>%
  sort(decreasing = TRUE)
```

First, we show missing values by column. We could conclude that there are most missing values in "Age" while "ZipCode" and "Breed" come second and third. We can roughly analyze the possible reasons. Most of dog owners adopt or purchase their dogs, thus some of them may not be sure of the date of birth. Of course, dogs of some owners are born to the big dog at home, or they know the dogs’ birthday when they purchase them, but some owners are hard to know. This is a very common situation. In addition, many dog owners' dogs may be hybrid breeds, or stray dogs adopted by owners. In these situations, owners may not be sure of the "breed" of their dogs. As for the "ZipCode", dog bites may not always happen near the dog owners’ houses, so owners may not be familiar with the "ZipCode" there. Of course, many careful dog owners will inquire and fill in "ZipCode", but others may not fill in it.

All of other columns do not have any missing value. In class, Prof. Robbins mentioned that we could consider the connection between some columns, such as the address and the zipcode. In our data, we noticed that there is no connection of missing values between "ZipCode" and "Borough" according to the current analysis. We could not see any other connections right now.

### Missing values by row

Since we have 10280 rows, it is not clear if we continue analyzing with all of the data. Our data only contains one file, thus we randomly select 40 rows for analysis.

```{r}
sampleDogBite <- sample_n(DogBite, 40)
```

```{r}
rowSums(is.na(sampleDogBite)) %>%
  sort(decreasing = TRUE)
```

Then we show missing values by row from large to small. We found that rows with the most missing values miss 3 values (i.e, "Age", "ZipCode", and "Breed"), while rows with the least missing values miss 0 value. There are only a small part of events in which all three values are missing.

### Row / column missing patterns - heatmap

```{r, fig.height = 12, fig.width = 12}
library(tidyverse)
tidyDogBite <- sampleDogBite %>% 
    rownames_to_column("id") %>% 
    gather(key, value, -id) %>% 
    mutate(missing = ifelse(is.na(value), "yes", "no"))
ggplot(tidyDogBite, aes(x = key, y = fct_rev(id), fill = missing)) +
  geom_tile(color = "white") + 
  ggtitle("DogBite with NAs added") +
  scale_fill_viridis_d() + # discrete scale
  theme_bw()
```

Now we could show the heatmap to analyze the row / column missing patterns and distributions of missing values. In our heatmap, we discover that the vast majority of rows that miss “breed” and “ZipCode” also miss “Age”. There are only 2 exceptions in our 40 sample rows. One possible reason is that the most easily unknown characteristic of dogs is “age”. If dog owners do not know the age of dogs when adopting or purchasing it, it will be difficult to know in the future. However, the “breed” information can be identified through later medical tests, and “ZipCode” can also be queried after the dog bite events. If not even the easily known information of “breed” and “ZipCode” is available, it indicates that the data has limited information about these dogs and dog bite events, so it is easy to miss “age”.

### Row / column missing patterns - gg_miss_fct

Since most columns of our dataset contain categorical data, it is not proper to analyze row / column missing patterns with mi::missing_data.frame() for heatmaps or with “geom_tile()” for missing values by variable as we discussed in class. In order to better analyze categorical data, we think “gg_miss_fct()” is a better choice. We choose three columns, i.e., “Gender”, “SpayNeuter”, and “Borough”, to analyze the patterns. The plots show the proportions of missing values in different categories of the certain column. Note that we use the entire dataset instead of our 40 samples in this part for better discussion.

```{r}
library(naniar)
gg_miss_fct(x = DogBite, fct = Gender)
```

In the plot, “F” denotes “Female”, “M” denotes “Male”, and “U” denotes “Unknown”. The plot shows that most events whose “Gender” is “Unknown” miss “Age”, and about half of these events miss “Breed” and “ZipCode”. However, few events whose “Gender” is “Male” or “Female” miss “Age”, “Breed”, and “ZipCode”, and there is no great difference between the patterns of “Male” and “Female”. We could analyze this situation. As we discussed above, the most easily unknown characteristic of dogs is “Age”. If dog owners do not know the age of dogs when adopting or purchasing it, it will be difficult to know in the future. Although “breed” and “ZipCode” are also easily be missed, they are a little easier to be obtained than “Age”. The “breed” information can be identified through later medical tests, and “ZipCode” can also be queried after the dog bite events. However, the “Gender” information can be identified through observations or medical tests easily. If in an event, we do not even know the gender of the dog, it indicates that the data has limited information about these dogs and dog bite events, it is easy to miss “Age”, “Breed”, and “ZipCode”, especially “Age”. In addition, there is not much difference between patterns of missing values in female and male dogs, since the gender will not influence the patterns.

```{r}
gg_miss_fct(x = DogBite, fct = SpayNeuter)
```

In the plot, “false” and “true” denote the situation of SpayNeuter of dogs. The plot shows that most events whose “SpayNeuter” is “false” miss “Age”, and about half of these events miss “Breed” and “ZipCode”. However, few events whose “SpayNeuter” is “true” miss “Age”, “Breed”, and “ZipCode”. We could analyze this situation. As we discussed above, the most easily unknown characteristic of dogs is “Age”. If dog owners do not know the age of dogs when adopting or purchasing it, it will be difficult to know in the future. Although “breed” and “ZipCode” are also easily be missed, they are a little easier to be obtained than “Age”. The “breed” information can be identified through later medical tests, and “ZipCode” can also be queried after the dog bite events. If in an event, “SpayNeuter” is true, which means the dog is well taken care of and controlled, these careful dog owners are more likely to know the “Age”, “Breed”, and “ZipCode”. By contrast, when it is false, it is more likely to miss “Age”, “Breed”, and “ZipCode”, especially “Age”.

```{r}
gg_miss_fct(x = DogBite, fct = Borough)
```

The plot denotes the patterns of missing values in different boroughs. The plot shows that whatever the borough is, it is more likely to miss “Age” than “Breed” and “ZipCode”, which is consistent with what we discussed above. There is one exception. When the “Borough” is “Other”, i.e., we do not know the specific borough, 50% of events miss “ZipCode”. This is reasonable and Prof. Robbins also gave a similar example in class. Since both of “Borough” and “ZipCode” contain the information of the address, there is the connection between them. When we do not know the specific borough, it is likely to miss “ZipCode”.

### Missing patterns

```{r}
x <- mi::missing_data.frame(sampleDogBite)
```

```{r}
class(x)
```

```{r}
x@patterns
```

This part lists the situation of missing values of our 40 samples. Each one indicates the kinds of values that are missed in each sample.

```{r}
levels(x@patterns)
```

This part lists all of the patterns above.

```{r}
summary(x@patterns)
```

This part shows the specific counts of patterns above.

Then, we aim to create a missing values plot in the style of extracat::visna() (no longer available on CRAN) using ggplot2. First, we create the function for creating missing plots.

```{r}
plot_missing <- function(dataset, percent = TRUE) {
  library(cowplot)
  
  ###### for right plot ######
  missing_patterns <- data.frame(is.na(dataset)) %>%
    group_by_all() %>%
    count(name = "count", sort = TRUE) %>%
    ungroup()
  
  missing_patterns <- missing_patterns %>%
    mutate(pattern = 1:nrow(missing_patterns)) %>%
    mutate(pattern = fct_reorder(as.factor(pattern), count))%>%
    mutate(alpha = ifelse(
        rowSums(missing_patterns[, -ncol(missing_patterns)]) == 0, 
        "dark", "light"))
  
  missing_patterns$pattern <- factor(missing_patterns$pattern,
                                     levels = nrow(missing_patterns):1)
  
  ###### for up plot ######
  dataset1 <- dataset %>%
    rownames_to_column("id") %>%
    gather("feature", "value", -id) %>%
    mutate(missing = ifelse(is.na(value), 1, 0))
  
  missing_row <- dataset1 %>%
    group_by(feature) %>%
    summarise(n = sum(missing)) %>%
    mutate(feature = fct_reorder(feature, n))
  
  missing_row$feature <- factor(missing_row$feature, rev(levels(missing_row$feature)))
  
  ###### for middle plot ######
  dataset2 <- missing_patterns %>%
    select(-count, -pattern) %>%
    rownames_to_column("id") %>%
    gather("feature", "value", -c(id, alpha))
  
  dataset2$id <- factor(dataset2$id, levels = nrow(missing_patterns):1)
  dataset2$feature <- factor(dataset2$feature, levels = levels(missing_row$feature))
  
  middle <- dataset2 %>%
    ggplot(aes(x = feature, y = id, fill = value, alpha = alpha)) +
    geom_tile(color = "white") +
    scale_fill_manual(values = c("grey", "purple"), guide = "none") +
    labs(x = "variable", y = "missing patterns") + 
    scale_alpha_manual(values = c(2, .5), guide = "none") +
    annotate("text",
             x = rep(6, sum(missing_patterns$alpha == "dark")),
             y = length(missing_patterns$alpha) - which(missing_patterns$alpha == "dark") + 1,
             label = rep("complete cases", sum(missing_patterns$alpha == "dark"))
            ) +
    theme(axis.text.x = element_text(vjust = .5, hjust = .5, angle = 45))
  
  if(percent == FALSE) {
    right <- missing_patterns %>%
      ggplot(aes(y=count, x=pattern, alpha = alpha)) + 
      geom_bar(stat = "identity", fill = "lightblue") +
      theme_bw() +
      labs(x = "", y = "row count") +
      coord_flip() +
      scale_alpha_manual(values = c(2, .5), guide = "none")
    
    up <- missing_row %>%
      ggplot(aes(x = feature, y = n)) + 
      geom_bar(stat = "identity", fill = "lightblue") +
      theme_bw() + 
      labs(x = "", y = "num rows missing", title = "Missing value patterns") +
      theme(axis.text.x = element_text(vjust = 0.5, hjust = 0.5, angle = 45))
    
    res = plot_grid(up, NULL, middle, right, 
                    rel_heights = c(1, 2),
                    rel_widths = c(2, 1),
                    align = "hv")
  } else if (percent == TRUE) {
    right <- missing_patterns %>%
      ggplot(aes(y = count/sum(count) * 100, x = pattern, alpha = alpha)) +
      geom_bar(stat = "identity", fill = "lightblue") +
      theme_bw() +
      labs(x = "", y = "% rows", title = "") +
      coord_flip() +
      scale_alpha_manual(values = c(2, .5), guide = "none")
    
    up <- missing_row %>%
      ggplot(aes(x = feature, y = n/nrow(dataset)*100)) + 
      geom_bar(stat = "identity", fill = "lightblue") +
      theme_bw() + 
      labs(x = "", y = "num rows missing", title = "Missing value patterns") +
      theme(axis.text.x = element_text(vjust = 0.5, hjust = 0.5, angle = 45))
    
    res = plot_grid(up, NULL, middle, right, 
                    rel_heights = c(1, 2),
                    rel_widths = c(3, 1),
                    align = "hv")
  }
  return(res)
}
```

Then we use the function to draw the plot. Note that we use the entire dataset instead of our 40 samples in this part for better discussion.

```{r}
DogBiteForPlot <- subset(DogBite, select = -c(UniqueID))
plot_missing(DogBiteForPlot, percent = FALSE)
```

First, we could analyze the left upper corner of this plot, which sorts the counts of rows that miss certain values. We found that there are most missing values in “Age” while “ZipCode” and “Breed” come second and third. All of other columns do not have any missing value. We can analyze the possible reasons. Most of dog owners adopt or purchase their dogs, thus some of them may not be sure of the date of birth. Of course, dogs of some owners are born to the big dog at home, or they know the dogs’ birthday when they purchase them, but some owners are hard to know. This is a very common situation. In addition, many dog owners’ dogs may be hybrid breeds, or stray dogs adopted by owners. In these situations, owners may not be sure of the “breed” of their dogs. As for the “ZipCode”, dog bites may not always happen near the dog owners’ houses, so owners may not be familiar with the “ZipCode” there. Of course, many careful dog owners will inquire and fill in “ZipCode”, but others may not fill in it.

Second, we could analyze the left lower corner, which shows all of the patterns, i.e., miss nothing, only miss “Age”, miss “Age” and “ZipCode”, miss “Age” and “ZipCode” and “Breed”, only miss “ZipCode”, miss “Age” and “Breed”, only miss “Breed”, miss “ZipCode” and “Breed”. 

Third, we analyze the right lower corner, which sort the counts of 8 kinds of patterns we mentioned above. We could conclude that most events miss nothing. Events that only miss “Age” come second. Events that miss “Age” and “ZipCode” come third. Events that miss “ZipCode” and “Breed” is the least. We will analyze them separately. 

Most events miss nothing, which shows that the quality of our dataset is good. 

Many events only miss “Age”. As we discussed above, the most easily unknown characteristic of dogs is “Age”. If dog owners do not know the age of dogs when adopting or purchasing it, it will be difficult to know in the future. Although “breed” and “ZipCode” are also easily be missed, they are a little easier to be obtained than “Age”. The “breed” information can be identified through later medical tests, and “ZipCode” can also be queried after the dog bite events. 

Events that miss “Age” and “ZipCode” come third. As we mentioned above, “ZipCode” is easier to be obtained than “Age”. If in an event, we even do not know “ZipCode”, it indicates that the data has limited information about these dogs and dog bite events, it is easy to miss “Age”. In addition, this also indicate that “Breed” is easier to be obtained than “Age” and “ZipCode”, which is consistent with the left upper corner of this plot. 

Events that miss “ZipCode” and “Breed” is the least. As we mentioned above, the most easily unknown characteristic of dogs is “Age”. It is easier to obtain “Breed” and “ZipCode”. If we do not even know “Breed” and “ZipCode”, it is less likely to know “Age”.

```{r}
DogBiteForPlot <- subset(DogBite, select = -c(UniqueID))
plot_missing(DogBiteForPlot, percent = TRUE)
```

In this part, we draw a plot using our function, i.e., plot_missing(DogBiteForPlot, percent = TRUE). The situation is similar to the above plot from plot_missing(DogBiteForPlot, percent = FALSE).

### Missing by borough

```{r}
percent_missing <- DogBite %>% group_by(Borough) %>% 
  summarize(num_bites = n(), num_na = sum(is.na(`Age`))) %>% 
  mutate(percent_na = round(num_na/num_bites, 2)) %>% 
  arrange(-percent_na)
percent_missing
```

First, we show the percent of missing values of “Age” in different boroughs. Note that we use the entire dataset instead of our 40 samples in this part for better discussion. Events in “Bronx” is most likely to miss “Age”. There is not a large difference between the percent of different boroughs.

```{r}
percent_missing <- DogBite %>% group_by(Borough) %>% 
  summarize(num_bites = n(), num_na = sum(is.na(`Breed`))) %>% 
  mutate(percent_na = round(num_na/num_bites, 2)) %>% 
  arrange(-percent_na)
percent_missing
```

Now we show the percent of missing values of “Breed” in different boroughs. Events in “Other” is most likely to miss “Breed”. One possible reason is that according to our discussion above, there is a connection between “ZipCode” and “Borough”, which indicates that if we do not know the specific borough, it is more likely to miss “ZipCode”. If we do not even know “ZipCode”, it indicates that the data has limited information about these dogs and dog bite events, so it is easy to miss “Breed”.

```{r}
percent_missing <- DogBite %>% group_by(Borough) %>% 
  summarize(num_bites = n(), num_na = sum(is.na(`ZipCode`))) %>% 
  mutate(percent_na = round(num_na/num_bites, 2)) %>% 
  arrange(-percent_na)
percent_missing
```

Then we show the percent of missing values of “ZipCode” in different boroughs. Events in “Other” is most likely to miss “ZipCode”. One possible reason is that according to our discussion above, there is a connection between “ZipCode” and “Borough”, which indicates that if we do not know the specific borough, it is more likely to miss “ZipCode”. 

```{r}
percent_missing <- DogBite %>% group_by(Borough) %>% 
  summarize(num_bites = n(), num_na = sum(is.na(`Age`))) %>% 
  mutate(percent_na = round(num_na/num_bites, 2)) %>% 
  arrange(-percent_na)
DogBitesum <- DogBite %>% 
  group_by(Borough) %>% 
  summarize(meanAge = round(mean(as.numeric(`Age`), na.rm = TRUE), 1)) %>%
  left_join(percent_missing %>% select(Borough, percent_na),
            by = "Borough") %>% 
  arrange(desc(percent_na))
DogBitesum
```

```{r}
DogBitesumtidy <- DogBitesum %>%
  pivot_longer(cols = meanAge,
               names_to = "subject",
               values_to = "meanscore")
ggplot(DogBitesumtidy, aes(meanscore, percent_na, color = Borough)) + geom_point(size = 2) + facet_wrap(~subject) + theme_bw() +
  theme(legend.position = "bottom")
```

We also explore the relationship between average age of dogs and the missing percent of “Age” in different boroughs. We could roughly infer that the smaller the average age is, the higher the missing percent of “Age” is. However, this relationship is not stable and not obvious.

### Number of missing by year

```{r}
processed_DogBite <- DogBite %>%
  mutate(Year = case_when(
  str_detect(DogBite$DateOfBite, "2015") ~ "2015",
  str_detect(DogBite$DateOfBite, "2016") ~ "2016",
  str_detect(DogBite$DateOfBite, "2017") ~ "2017"
))

missing <- processed_DogBite %>% 
  group_by(Year) %>% 
  summarise(sum.na = sum(is.na(Age)))

ggplot(missing, aes(x = 1:3, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:3, labels = missing$Year) +
  ggtitle("Number of missing values by year") +
  xlab("") +
  ylab("Number of missing ages") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(Year) %>% 
  summarise(sum.na = sum(is.na(Breed)))

ggplot(missing, aes(x = 1:3, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:3, labels = missing$Year) +
  ggtitle("Number of missing values by year") +
  xlab("") +
  ylab("Number of missing breeds") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(Year) %>% 
  summarise(sum.na = sum(is.na(ZipCode)))

ggplot(missing, aes(x = 1:3, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:3, labels = missing$Year) +
  ggtitle("Number of missing values by year") +
  xlab("") +
  ylab("Number of missing ZipCodes") +
  theme(axis.text.x = element_text(angle = 90))
```

We process our data and show the number of missing values by year, i.e., 2015, 2016, and 2017. Note that we use the entire dataset instead of our 40 samples in this part for better discussion. We use three plots to show the situations of “Age”, “Breed”, and “ZipCode” separately. We could see that in all of the three plots, events in 2015 miss most values. From 2015 to 2017, the number of missing values gradually decreased in total (especially for “Breed”). However, we are not sure whether this is due to the optimization of management, or because the data contained in our dataset in 2015 is the most. Thus, we show the proportion of missing values by year then.

```{r}
missing <- processed_DogBite %>% 
  group_by(Year) %>% 
  summarise(num = n(), sum.na = sum(is.na(Age))) %>%
  mutate(percent_na = sum.na/num)

ggplot(missing, aes(x = 1:3, y = percent_na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:3, labels = missing$Year) +
  ggtitle("Proportion of missing values by year") +
  xlab("") +
  ylab("Proportion of missing ages") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(Year) %>% 
  summarise(num = n(), sum.na = sum(is.na(Breed))) %>%
  mutate(percent_na = sum.na/num)

ggplot(missing, aes(x = 1:3, y = percent_na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:3, labels = missing$Year) +
  ggtitle("Proportion of missing values by year") +
  xlab("") +
  ylab("Proportion of missing breeds") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(Year) %>% 
  summarise(num = n(), sum.na = sum(is.na(ZipCode))) %>%
  mutate(percent_na = sum.na/num)

ggplot(missing, aes(x = 1:3, y = percent_na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:3, labels = missing$Year) +
  ggtitle("Proportion of missing values by year") +
  xlab("") +
  ylab("Proportion of missing ZipCodes") +
  theme(axis.text.x = element_text(angle = 90))
```

We found that in the proportion of missing values by year, it is clear that as time goes on, the proportion of missing value has a decreasing trend, especially for “Breed” and “ZipCode”. One possible reason is that the government has strengthened its management of dog bites and put forward higher requirements for data integrity. As a result, there are less missing values in 2017.

### Number of missing by month

```{r}
processed_DogBite <- DogBite %>%
  mutate(Month = case_when(
    str_detect(DogBite$DateOfBite, "January") ~ "01",
    str_detect(DogBite$DateOfBite, "February") ~ "02",
    str_detect(DogBite$DateOfBite, "March") ~ "03",
    str_detect(DogBite$DateOfBite, "April") ~ "04",
    str_detect(DogBite$DateOfBite, "May") ~ "05",
    str_detect(DogBite$DateOfBite, "June") ~ "06",
    str_detect(DogBite$DateOfBite, "July") ~ "07",
    str_detect(DogBite$DateOfBite, "August") ~ "08",
    str_detect(DogBite$DateOfBite, "September") ~ "09",
    str_detect(DogBite$DateOfBite, "October") ~ "10",
    str_detect(DogBite$DateOfBite, "November") ~ "11",
    str_detect(DogBite$DateOfBite, "December") ~ "12")) %>%
  mutate(Year = case_when(
    str_detect(DogBite$DateOfBite, "2015") ~ "2015",
    str_detect(DogBite$DateOfBite, "2016") ~ "2016",
    str_detect(DogBite$DateOfBite, "2017") ~ "2017")) 
processed_DogBite$CombinedDate <- str_c(processed_DogBite$Year, "-", processed_DogBite$Month)
missing <- processed_DogBite %>% 
  group_by(CombinedDate) %>% 
  summarise(sum.na = sum(is.na(Age))) %>%
  arrange(CombinedDate)

ggplot(missing, aes(x = 1:36, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:36, labels = missing$CombinedDate) +
  ggtitle("Number of missing values by month") +
  xlab("") +
  ylab("Number of missing ages") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(CombinedDate) %>% 
  summarise(sum.na = sum(is.na(Breed))) %>%
  arrange(CombinedDate)

ggplot(missing, aes(x = 1:36, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:36, labels = missing$CombinedDate) +
  ggtitle("Number of missing values by month") +
  xlab("") +
  ylab("Number of missing breeds") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(CombinedDate) %>% 
  summarise(sum.na = sum(is.na(ZipCode))) %>%
  arrange(CombinedDate)

ggplot(missing, aes(x = 1:36, y = sum.na)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_continuous(breaks = 1:36, labels = missing$CombinedDate) +
  ggtitle("Number of missing values by month") +
  xlab("") +
  ylab("Number of missing ZipCodes") +
  theme(axis.text.x = element_text(angle = 90))
```

For further analysis, we process our data and show the number of missing values by month, e.g., 2015-01, 2015-02. Note that we use the entire dataset instead of our 40 samples in this part for better discussion. We use three plots to show the situations of “Age”, “Breed”, and “ZipCode” separately. We could see that from 2015 to 2017, the number of missing values gradually decreased in total (especially for “Breed”). In addition, the plot has the periodicity, and the number of missing values increases in summer of each year. However, we are not sure whether this is due to the optimization of management and particularity of summer, or because the data quantity. Thus, we show the proportion of missing values by month then.

```{r}
missing <- processed_DogBite %>% 
  group_by(CombinedDate) %>% 
  summarise(num_bites = n(), sum.na = sum(is.na(Age))) %>%
  mutate(percent_na = sum.na/num_bites) %>% 
  arrange(CombinedDate)

ggplot(missing, aes(x = 1:36, y = percent_na)) +
  geom_point() +
  scale_x_continuous(breaks = 1:36, labels = missing$CombinedDate) +
  ggtitle("Proportion of missing values by month") +
  xlab("") +
  ylab("Proportion of missing ages") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(CombinedDate) %>% 
  summarise(num_bites = n(), sum.na = sum(is.na(Breed))) %>%
  mutate(percent_na = sum.na/num_bites) %>% 
  arrange(CombinedDate)

ggplot(missing, aes(x = 1:36, y = percent_na)) +
  geom_point() +
  scale_x_continuous(breaks = 1:36, labels = missing$CombinedDate) +
  ggtitle("Proportion of missing values by month") +
  xlab("") +
  ylab("Proportion of missing breeds") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
missing <- processed_DogBite %>% 
  group_by(CombinedDate) %>% 
  summarise(num_bites = n(), sum.na = sum(is.na(ZipCode))) %>%
  mutate(percent_na = sum.na/num_bites) %>% 
  arrange(CombinedDate)

ggplot(missing, aes(x = 1:36, y = percent_na)) +
  geom_point() +
  scale_x_continuous(breaks = 1:36, labels = missing$CombinedDate) +
  ggtitle("Proportion of missing values by month") +
  xlab("") +
  ylab("Proportion of missing ZipCodes") +
  theme(axis.text.x = element_text(angle = 90))
```

We found that in the proportion of missing values by month, it is clear that as time goes on, the proportion of missing value has a decreasing trend. One possible reason is that the government has strengthened its management of dog bites and put forward higher requirements for data integrity. In addition, the plot has the periodicity, and the proportion of missing values increases in summer of each year. We do not know the reason now. We will further analyze the time series in our final project to try to solve this problem.

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results
1. Process data
 a. read doge bite data csv and other supplement data

```{r, message=FALSE}
library(pacman)
p_load(tidyverse)
p_load(lubridate)
p_load(ggExtra)


lct <- Sys.getlocale("LC_TIME")
Sys.setlocale("LC_TIME", "C")

DogBiteDF <- read_csv("DOHMH_Dog_Bite_Data.csv", na = c("", "NA","?"))
Temperature <- read_csv("tempbymonth.csv", na = c("", "NA"))
DogRegDF <- read_csv("NYC_Dog_Licensing_Dataset.csv")
```
 b. data clean
  i. DateOfBite:
    Extract the Year and Month from the column 'DateofBite'
  ii: Breed
    There are numerous data with empty breed, so let's set them as unknown
  iii: Age
    Several age records are string not numeric. Covert age in months to age in years. 
```{r, echo = FALSE}
DogBiteDF <- DogBiteDF %>% 
  mutate(MonthOfBite = month(strptime(pull(DogBiteDF, DateOfBite), 
                                      format="%B %d %Y"))) %>% 
  mutate(YearOfBite = year(strptime(pull(DogBiteDF, DateOfBite), 
                                      format="%B %d %Y"))) %>% 
  mutate(Breed = replace_na(Breed, 'UNKNOWN')) %>% 
  mutate(Age = if_else(grepl('Y|y', Age, fixed = TRUE),parse_number(Age),
                       if_else(grepl('M|m', Age, fixed = TRUE), 
                               parse_number(Age)/12, 
                               parse_number(replace_na(Age,'-1'))
            )
    )
  )
  
# 
```
  iv: Reshape the temperature data frame
  v: DogBite dataframe left join temperature.
```{r, warning=FALSE}
Temperature <- Temperature %>% 
  pivot_longer(!Year, names_to = "Month", 
               names_transform = list(Month = as.integer),
               values_to = "Avg_temp",
               values_drop_na = TRUE)

DogBiteDF <- DogBiteDF %>% left_join(., Temperature, 
                                     by=c('MonthOfBite'='Month', 'YearOfBite'='Year'), suffix = c("_x", "_y"))
```

 c. Draw graphs
  i. The distribution of bite record on borough and years
```{r, warning=FALSE}
data_for_draw <- DogBiteDF %>% 
  group_by(YearOfBite, Borough) %>% 
  count(name='value') %>% 
  arrange(YearOfBite, value)

# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 1
to_add <- data.frame(matrix(NA, empty_bar*nlevels(as.factor(data_for_draw$YearOfBite)), ncol(data_for_draw)))
colnames(to_add) <- colnames(data_for_draw)
to_add$YearOfBite <- rep(as.numeric(levels(as.factor(data_for_draw$YearOfBite))), each=empty_bar)
data_for_draw <- rbind(data_for_draw, to_add)
data_for_draw <- data_for_draw %>% arrange(YearOfBite)
data_for_draw$id <- seq(1, nrow(data_for_draw))

# Get the name and the y position of each label
label_biteDF <- data_for_draw
number_of_bar <- nrow(label_biteDF)
angle <- 90 - 360 * (label_biteDF$id-0.5) /number_of_bar
label_biteDF$hjust <- ifelse(angle < -90, 1, 0)
label_biteDF$angle <- ifelse(angle < -90, angle+180, angle)
 
# prepare a data frame for base lines
baselines_DF <- data_for_draw %>% 
  group_by(YearOfBite) %>% 
  summarize(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))
 
# prepare a data frame for grid (scales)
grid_data <- baselines_DF
grid_data$end <- grid_data$end[c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]
 
# Make the plot
graph1 <- ggplot(data_for_draw, aes(x=as.factor(id), y=value, fill=as.factor(YearOfBite))) +
  
  geom_bar(stat="identity", alpha=0.5) +
  annotate("text", x = rep(max(data_for_draw$id),4), y = c(200, 400, 600, 800), label = c("200", "400", "600", "800") , color="grey", size=2 , angle=0, fontface="bold", vjust=0.5) +
  
  ylim(-500,900) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar() +
  geom_text(data=label_biteDF, aes(x=id, y=value+10, label=Borough, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_biteDF$angle, inherit.aes = FALSE ) +
  # Add base line information
  geom_segment(data=baselines_DF, aes(x = start, y = -50, xend = end, yend = -51), colour = "black", alpha=0.8, size=0.6 , inherit.aes = FALSE ) +
  geom_text(data=baselines_DF, aes(x = title, y = -150, label=YearOfBite), vjust=1, colour = "black", alpha=0.8, size=2, fontface="bold", inherit.aes = FALSE) +
  scale_color_brewer(palette = "RdYlBu")

graph1 
```
 
 ii. The distribution of bite record with the time.
```{r}
data_for_draw_1 <- DogBiteDF %>% 
  group_by(MonthOfBite, Borough) %>% 
  count(name='value') %>% 
  arrange(Borough, MonthOfBite)
data_for_draw_1$Borough <- as.factor(data_for_draw_1$Borough) %>% 
  fct_reorder(., data_for_draw_1$value, min, .desc = TRUE)

graph2 <- ggplot(data_for_draw_1, aes(x=as.factor(MonthOfBite), y=value, fill=as.factor(Borough))) +
  geom_bar(stat = "identity", width=0.8) +
  facet_wrap(~ Borough, ncol = 2) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title="Bite records count by month",
        x ="Month", y = "Numbers") +
  scale_color_brewer(palette = "RdYlBu")


graph2
```
  
  iii: The distribution of bite record with month average temperature.
```{r, message=FALSE, warning=FALSE}
data_for_draw_2 <- DogBiteDF %>% 
  group_by(Avg_temp, Borough) %>% 
  count(name='value') %>% 
  arrange(Borough, Avg_temp)
data_for_draw_2$Borough <- as.factor(data_for_draw_2$Borough) %>% 
  fct_reorder(., data_for_draw_2$value, min, .desc = TRUE)

graph3 <- ggplot(data_for_draw_2, aes(x=Avg_temp, y=value, color=as.factor(Borough))) +
  geom_point() +
  geom_smooth(method = "loess") +
  facet_wrap(~ Borough, ncol = 2, scales='free_y') +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title="Bite records count by Monthly Average Temperature",
        x ="Temperature(F)", y = "Numbers") +
  scale_color_brewer(palette = "RdYlBu")


graph3
```

  iv: The distribution of bite record with breed, age, gender and neuter or not.
```{r}
p_load(scales)

data_for_draw_3 <- DogBiteDF %>% 
  group_by(Breed) %>% 
  count(name='value') %>% 
  arrange(desc(value))
data_for_draw_3$Breed <- as.factor(data_for_draw_3$Breed) %>%
  fct_reorder(., data_for_draw_3$value, min, .desc = TRUE)

data_for_draw_3$fraction <- data_for_draw_3$value / sum(data_for_draw_3$value)
data_for_draw_3$ymax <- cumsum(data_for_draw_3$fraction)
data_for_draw_3$ymin <- c(0, head(data_for_draw_3$ymax, n=-1))
data_for_draw_3$labelPosition <- (data_for_draw_3$ymax + data_for_draw_3$ymin) / 2

# Compute a good label
data_for_draw_3$label <- paste0(data_for_draw_3$Breed, ":\n ", data_for_draw_3$value)
data_for_draw_3 <- data_for_draw_3 %>% head(9)
# Make the plot
graph4 <- ggplot(data_for_draw_3, aes(ymax=ymax, ymin=ymin, xmax=3, xmin=2, fill=Breed)) +
  geom_rect() +
  geom_text(x=3.5, aes(y=labelPosition, label=percent(fraction,accuracy=0.01)), size=3, inherit.aes = FALSE) + 
  scale_fill_brewer(palette="RdYlBu") +
  # scale_color_brewer(palette="RdYlBu") +
  coord_polar(theta="y") +
  xlim(c(0, 3)) +
  theme_void() +
  labs(title="Bite records count by Breed (Top 9)")

data_for_draw_3 <- DogRegDF %>% 
  rename(., Breed = BreedName) %>%
  mutate(Breed = replace_na(Breed, 'UNKNOWN')) %>% 
  group_by(Breed) %>% 
  count(name='value') %>% 
  arrange(desc(value)) 

data_for_draw_3$Breed <- as.factor(data_for_draw_3$Breed) %>%
  fct_reorder(., data_for_draw_3$value, min, .desc = TRUE)

data_for_draw_3$fraction <- data_for_draw_3$value / sum(data_for_draw_3$value)
data_for_draw_3$ymax <- cumsum(data_for_draw_3$fraction)
data_for_draw_3$ymin <- c(0, head(data_for_draw_3$ymax, n=-1))
data_for_draw_3$labelPosition <- (data_for_draw_3$ymax + data_for_draw_3$ymin) / 2

# Compute a good label
data_for_draw_3$label <- paste0(data_for_draw_3$Breed, ":\n ", data_for_draw_3$value)
data_for_draw_3 <- data_for_draw_3 %>% head(9)
# Make the plot
graph5 <- ggplot(data_for_draw_3, aes(ymax=ymax, ymin=ymin, xmax=3, xmin=2, fill=Breed)) +
  geom_rect() +
  geom_text(x=3.5, aes(y=labelPosition, label=percent(fraction,accuracy=0.01)), size=3, inherit.aes = FALSE) + 
  scale_fill_brewer(palette="RdYlBu") +
  # scale_color_brewer(palette="RdYlBu") +
  coord_polar(theta="y") +
  xlim(c(0, 3)) +
  theme_void() +
  labs(title="NYC Dog Registered Number on Breed (Top 9)")


graph4
graph5
```

```{r}
p_load(ggridges)

data_for_draw_4 <- DogBiteDF %>% 
  filter(Age<25 & Age > 0) 
  # group_by(Age, Borough) %>% 
  # count(name='value') %>% 
  # arrange(Borough, Age)
data_for_draw_4$Borough <- as.factor(data_for_draw_4$Borough)

graph5 <- data_for_draw_4 %>%
  ggplot(aes(y=Borough, x=Age,  fill=Borough)) +
    geom_density_ridges(alpha=0.6, stat="binline", bins=22, scale=0.9) +
    theme_ridges() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.5, "lines"),
    ) +
    labs(title="Bite records count by Age",
        x ="Age (Year)", y = "Numbers")

graph5

```

```{r}
data_for_draw_5 <- DogBiteDF %>% 
  group_by(Gender, SpayNeuter) %>% 
  count(name = 'Number') %>% 
  ungroup()

graph6 <- ggplot(data_for_draw_5, aes(Gender, SpayNeuter, fill= Number)) + 
  geom_tile() +
  geom_text(aes(label = Number)) +
  scale_fill_gradient(low="orange", high="red") +
  theme_minimal()

graph6
```


```{r}
DogRegDF = DogRegDF %>% 
  separate(LicenseIssuedDate, sep = "/", into = c(NA,NA,"YearOfIssued"), remove = FALSE)
DogRegDF$YearOfIssued = as.numeric(DogRegDF$YearOfIssued)
DogRegDFt = subset(DogRegDF, YearOfIssued>=2015 & YearOfIssued<=2017)
DogRegDFt = DogRegDF
DogRegDFt$Age = DogRegDFt$YearOfIssued - DogRegDFt$AnimalBirthMonth
DogRegDFt = subset(DogRegDFt, Age <= 20 & Age >= 0)
DogBiteDFt = subset(DogBiteDF, Age <= 20 & Age >= 0)
data_for_draw_6 = DogBiteDFt["Age"]
data_for_draw_6$group = "Biting"
temp = DogRegDFt["Age"]
temp$group = "Licensed"
data_for_draw_6 = rbind(data_for_draw_6, temp)

graph7 = ggplot(data_for_draw_6, aes(x = Age, fill = group)) + 
  geom_histogram(position = "identity", bins = 20) + 
  facet_wrap(~ group, ncol = 1, scales="free_y") + 
  labs(title = "Bite Count & Licensed Count by Age", xlab = "Age (Year)") + 
  scale_fill_brewer(palette="Pastel1")

graph8 = ggplot(data_for_draw_6, aes(x = Age, fill = group)) + 
  geom_density(adjust = 1.5, alpha = 0.5) + 
  facet_wrap(~ group, ncol = 1, scales="free_y") + 
  labs(title = "Bite Count & Licensed Count Density Dist. by Age", xlab = "Age (Year)") + 
  scale_fill_brewer(palette="Pastel1")

graph7

graph8
```



```{r}
tempBite = DogBiteDF[c("YearOfBite","Gender")]
tempLic = DogRegDF[c("YearOfIssued","AnimalGender")]
colnames(tempLic)[2] = "Gender"
colnames(tempLic)[1] = "Year"
colnames(tempBite)[1] = "Year"
tempLic$Gender[is.na(tempLic$Gender)] = "U"
BiteC = tempBite %>% 
  group_by(Gender) %>% 
  count(name='count')
LicC = tempLic %>% 
  group_by(Gender) %>% 
  count(name='count')
# dog bite data
BiteC["Proportion"] = BiteC$count/sum(BiteC$count)
BiteC
# Licence data
LicC["Proportion"] = LicC$count/sum(LicC$count)
LicC
```



```{r}
tempBite$group = "Biting"
tempLic$group = "Licensed"

data_for_draw_7 = rbind(tempBite, tempLic)
data_for_draw_7 = subset(data_for_draw_7, Year >= 2015 & Year <= 2017)

graph9 = ggplot(data_for_draw_7, aes(x = Year, fill = Gender)) + 
  geom_histogram(position = "dodge", bins = 3) + 
  facet_wrap(~ group, ncol = 1, scales="free_y") + 
  labs(title = "Bite Count & Licensed Count by Gender Each Year", xlab = "Age (Year)") + 
  scale_fill_brewer(palette="Pastel1")

graph9
```



```{r}
DogRegDFtt = DogRegDF
DogRegDFtt $ZipCode = as.numeric(DogRegDFtt $ZipCode)
DogRegDFtt$Borough[DogRegDFtt$ZipCode>=10001 & DogRegDFtt$ZipCode <= 10282] = "Manhattan"
DogRegDFtt$Borough[DogRegDFtt$ZipCode>=10451 & DogRegDFtt$ZipCode <= 10475] = "Bronx"
DogRegDFtt$Borough[DogRegDFtt$ZipCode>=11201 & DogRegDFtt$ZipCode <= 11256] = "Brooklyn"
DogRegDFtt$Borough[(DogRegDFtt$ZipCode>=11004 & DogRegDFtt$ZipCode <= 11109) | (DogRegDFtt$ZipCode>=11351 & DogRegDFtt$ZipCode <= 11697)] = "Queens"
DogRegDFtt$Borough[DogRegDFtt$ZipCode>=10301 & DogRegDFtt$ZipCode <= 10314] = "Staten Island"
LicT = DogRegDFtt[c("Borough")]
LicT$group = "Licensed"
BiteT = DogBiteDF[c("Borough")]
BiteT$group = "Biting"
data_for_draw8 = rbind(LicT, BiteT)
graph10 = ggplot(data_for_draw8, aes(x = Borough, fill = group)) + 
  geom_bar() + 
  facet_wrap(~ group, ncol = 1, scales="free_y") + 
  labs(title = "Bite Count & Licensed Count by Borough", xlab = "Age (Year)") + 
  scale_fill_brewer(palette="Pastel1")
graph10
```



```{r}
t = DogBiteDF %>% 
  group_by(Breed) %>% 
  count(name='count') %>% 
  arrange(desc(count)) %>% 
  head(9)
breedList = c(t$Breed)
data_for_draw_9 = DogBiteDF[DogBiteDF$Breed %in% breedList,]
data_for_draw_9 = subset(data_for_draw_9, Age >= 0 & Age <= 20)
data_for_draw_9$Breed = str_wrap(data_for_draw_9$Breed, width = 10)
graph11 = ggplot(data_for_draw_9, aes(x=Breed, y=Age, fill=Breed)) + 
  geom_boxplot() +
  labs(title = "Dog Bites on Age by Breed (Top 9)") + 
  scale_fill_brewer(palette="Pastel1") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) + NULL
graph11
```

```{r}
bookdown::render_book("05-results.Rmd")
```



<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component

## Introduction
For this part, we plot the doughnut chart indicating the Top 9 proportion of dog bites accidents caused divided by breeds. To interact with the plot, you can click the areas in New York City (by default, it will show the whole New York City dog bite data) and the doughnut chart will show you the result

## Interactive Part
```{r cars}
htmltools::includeHTML("try.html")
```

<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

